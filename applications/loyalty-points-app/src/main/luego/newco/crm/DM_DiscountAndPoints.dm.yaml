---
imports: [ 'luego.text.*', 'luego.math.*' ]
description: Determine eligibility for a discount
rootNode: 'Eligible'

graph:
- node: 'Eligible'
  type: 'Compute'
  output: 'newco.crm.Response'
  body: >
    Response(
         discount = discount,
         loyaltyPointIncrement = `new points`,
         message = 'Hello ' + the customerName of `the request`)

  level: '0'
  y: '0.5'
  dependsOn: ['discount', 'new points', 'request']

- node: 'discount'
  type: 'Compute'
  output: 'Number'
  body: >
    {
      // If you purchased at least 50€, you get a 1% discount with a maximum discoutn of 10€
      let sum = (`the request`.products map (p => p.price)).sum;
      if sum >= 50.0
      then min(sum * 0.01, 10.0)
      else 0.0;
    }

  level: '1'
  y: '0.33'
  dependsOn: ['request']

- node: 'new points'
  type: 'Compute'
  output: 'Integer'
  body: >
    depending on the loyaltyLevel of `the request` {
      case None => 0
      case Some(level) => {
        let sum : Number = (`the request`.products map (p => p.price)).sum;
        let nump = depending on level {
          case `LoyaltyLevel.Silver` => min(sum * 0.01, 30.0)
          case `LoyaltyLevel.Gold` => min(sum * 0.015, 40.0)
          case `LoyaltyLevel.Platinum` => min(sum * 0.02, 50.0)
        };
        floorInt(nump);
      }
    }

  level: '1'
  y: '0.66'
  dependsOn: ['request']

- node: 'request'
  alias: 'the request'
  type: 'Info'
  output: 'newco.crm.Request'
  level: '2'
  y: '0.5'